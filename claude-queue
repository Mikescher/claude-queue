#!/usr/bin/env bash

set -euo pipefail

QUEUE_DIR="./.claude-queue"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
RESET='\033[0m'
BOLD='\033[1m'

mkdir -p "$QUEUE_DIR"

if git rev-parse --is-inside-work-tree &>/dev/null; then
    if [[ -n $(git status --porcelain) ]]; then
        git add -A
        echo ""
        echo -e "${GREEN}ğŸ’» git repository found - will auto create commits${RESET}"
        echo ""
    fi
fi

# Spinner function
spinner() {
    local pid=$1
    local delay=0.1
    local spinchars='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    local i=0
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${CYAN}  %s ${YELLOW}Waiting for next file...${RESET}" "${spinchars:i++%${#spinchars}:1}"
        sleep "$delay"
    done
    printf "\r\033[K"
}

while true; do
    next_file=$(find "$QUEUE_DIR" -maxdepth 1 -name '*.md' -type f | sort | head -n 1)

    if [[ -n "$next_file" ]]; then
        filename=$(basename "$next_file")
        start_time=$(date +%s)
        echo ""
        echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo -e "${GREEN}ğŸš€ ${BOLD}Starting${RESET}${GREEN}: ${CYAN}${filename}${RESET}"
        echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""

        output_file="${next_file%.md}.out"
        claude --print "$(cat "$next_file")" | tee "$output_file"
        mv "$next_file" "${next_file}.done"

        # Auto-commit if in a git directory
        if git rev-parse --is-inside-work-tree &>/dev/null; then
            if [[ -n $(git status --porcelain) ]]; then
                git add -A
                git commit -m "[ğŸ¤–] auto commit after claude-queue-item '${filename}'"
                echo -e "${GREEN}ğŸ“¦ ${BOLD}Committed${RESET}${GREEN}: auto commit after claude-queue-item '${filename}'${RESET}"
            fi
        fi

        end_time=$(date +%s)
        duration=$((end_time - start_time))
        minutes=$((duration / 60))
        seconds=$((duration % 60))
        if [[ $minutes -gt 0 ]]; then
            duration_str="${minutes}m ${seconds}s"
        else
            duration_str="${seconds}s"
        fi

        echo ""
        echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo -e "${BLUE}âœ… ${BOLD}Completed${RESET}${BLUE}: ${CYAN}${filename}${RESET} ${YELLOW}(${duration_str})${RESET}"
        echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
    else
        sleep 5 &
        spinner $!
    fi
done
